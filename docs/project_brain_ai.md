# AI哲学与核心原则

## 1. 项目设计宗旨：AI-First 三大核心原则

我们的项目基于三个不可动摇的核心宗旨，这些原则深深印记在每一行代码、每一个架构决策中：

### 🎨 Design with AI (与AI共同设计)
**理念**: AI不是工具，而是我们的设计合作伙伴。我们的系统让AI参与到创意过程的每一个环节。

**实现体现**:
- **动态模板生成**: `generateDynamicTemplate()` 让AI成为专业的布局建筑师，基于约束系统创建结构化设计
- **智能内容适配**: AI理解并遵循我们的Grid/Flexbox双模布局引擎
- **协作式工作流**: 双Agent架构（布局师+内容师）实现AI内部的专业分工协作

### 🔧 Design for AI (为AI而设计)
**理念**: 我们的架构、数据结构、接口都优先考虑AI的理解能力和操作便利性。

**实现体现**:
- **类型即真相**: `types.ts` 作为唯一数据契约来源，自动生成AI Schema，杜绝功能-提示词漂移
- **AI元数据系统**: `importance`, `aiInstructions`, `isContentLocked` 为AI提供精确的操作指导
- **原子化Schema设计**: `layoutBoxSchema`, `textSpanSchema` 等可组合式设计，让AI能够精确理解和操作每个组件
- **约束完整性规则**: 专为AI设计的布局约束规则，确保AI生成的布局在任何情况下都是有效的

### 🚀 AI-First (AI优先架构)
**理念**: 整个系统架构以AI能力为中心设计，确保AI能力的无限扩展性。

**实现体现**:
- **专家Agent生态**: 每个领域都有专门的AI专家（海报、长图文、图像处理、视觉解构），可无限扩展
- **适配器模式**: 支持多AI服务商的可插拔架构，轻松集成新的AI能力
- **Agent编排中心**: `App.tsx` 统一调度所有AI能力，实现复杂的AI工作流编排
- **AI操作抽象**: 所有复杂操作都被抽象为AI可理解的高级指令，为未来的"AI掌控编辑器"奠定基础

## 2. 项目目标

构建一个先进的、对话式的、可扩展的创意内容生成平台。用户通过自然语言与 AI 互动，完成从海报设计到图像处理等一系列复杂任务。核心是提供一个既智能易用，又具备专业级微调能力的强大工具。

## 3. 架构演进：从"上帝对象"到"专家 Agent 工作流"

项目初期，所有 AI 逻辑都集中在一个单一的服务文件中。这很快被证明是不可持续的，因为它违反了**单一职责原则**，导致了高耦合、低可测试性和差的可扩展性。

我们果断地进行了重构，采用了**"专家 Agent 工作流 (Specialist Agent Workflow)"**的核心架构理念。

-   **理念**: 将复杂的 AI 任务分解为由多个职责单一的"专家 Agent"协同完成的流水线。每个 Agent 只做一件事，并把它做到极致。
-   **优势**:
    -   **模块化**: 每个功能（海报、长图文、图像工具）都是一个独立的服务。
    -   **可测试性**: 可以独立测试每个 Agent 的功能。
    -   **可扩展性**: 添加新功能只需创建一个新的 Agent 服务，并在路由器中"注册"即可。
    -   **AI 性能**: 更小、更专注的 Prompt 会带来更稳定、更准确、更快的 AI 响应。

## 4. AI Agent 工作流深度剖析

应用程序的智能核心被分解为多个"专家 Agent"服务，由 `App.tsx` 进行编排。

### 4.1. chatRouterService.ts (意图路由器)

-   **职责**: 接收用户的原始消息，并将其转换为一个结构化的 JSON 指令。
-   **Prompt**: 它的系统指令包含了所有可用工具和模板的描述。它被严格指示去进行**语义分析**来选择最合适的工具和模板，并在没有强匹配时**必须回退**到 `templateId: 'none'`。
-   **输出**: `{ tool, templateId, prompt, reply, ... }`

### 4.2. App.tsx (总指挥/编排器)

-   **职责**: `processMessage` 函数接收来自路由器的 JSON，并像一个项目经理一样，将任务分派给相应的专家服务。

### 4.3. visualDeconstructorService.ts (AI 布局解构专家)

这是我们"从图片导入模板"功能的核心。它采用了比单 Agent 更优越的**双 Agent 工作流**。

-   **Agent A: AI 视觉分析师 (`analyzeImageContent`)**:
    -   **职责**: 一个纯粹的计算机视觉系统。它的**唯一**任务是分析图片，并生成一个高级的、语义化的**视觉大纲** (一个中间 JSON 格式)。它**不知道也不关心**我们最终的 `PosterTemplate` 格式。
    -   **优势**: 专注使其更准确。它不会因生成复杂的技术性 JSON 而分心，从而能更可靠地识别背景和元素。

-   **Agent B: AI 模板架构师 (`buildTemplateFromAnalysis`)**:
    -   **职责**: 一个纯粹的技术架构师。它**从未见过原始图片**。它的**唯一**任务是接收 Agent A 生成的视觉大纲，并将其"翻译"成我们系统所需的、技术上完全正确的 `PosterTemplate` JSON。
    -   **优势**: 分离关注点。它只专注于技术实现，确保了输出的模板结构稳固、符合所有约束规则。

这个双 Agent 架构从根本上解决了单 Agent 方案中常见的逻辑混乱、无法识别背景等问题。

### 4.4. posterAgentService.ts (海报设计专家)

这是最复杂的 Agent，它内部包含一个**两步工作流**，并经过了多次智能化升级。

-   **第一步：AI 布局建筑师 (`generateDynamicTemplate`)**:
    -   **触发**: 当 `templateId` 为 `'none'` 时被调用。
    -   **Prompt**: 它的系统指令极其专业和严格。它被告知：
        -   自己是一个使用**约束和网格布局**的专业设计师。
        -   **必须**遵循"约束完整性规则"（例如，`centerX` 必须与 `width` 配对）。
        -   **严禁**生成任何内容（`sections` 数组必须为空）。
    -   **输出**: 一个高质量的、无内容的、临时的 `PosterTemplate` 结构。

-   **第二步：AI 内容填充师 (`generatePosterLayout`)**:
    -   **输入**: 接收一个模板（无论是预设的还是动态生成的）和用户的请求。
    -   **Prompt**: 它的系统指令是"室内设计师"。它被告知：
        -   **必须**在给定的"蓝图"（模板结构）内工作。
        -   **黄金法则**: 如果一个 `LayoutBox` 是空的，**必须**根据其 `role` 为其创造新的、合适的 `TextSection` 或 `ImageSection`。
        -   **语言规则**: 生成的文本**必须**是中文，图片 prompt **必须**是英文。
    -   **智能化升级 1: 智能模板适配与缩放**:
        -   **问题**: 当一个为大尺寸设计的模板被应用到小尺寸画布时，模板内的字体、边距等固定像素值并未按比例缩小。
        -   **解决方案**: `posterAgentService.ts` 现在会计算一个精确的 `scaleFactor` (缩放因子)，并递归地遍历整个模板结构，将**所有**基于像素 (`px`) 的样式（如 `fontSize`, `padding`, `borderRadius`, `gap` 以及约束中的像素值）按比例缩放，同时保持百分比值不变。
    -   **智能化升级 2: 绝对的样式保真度**:
        -   **问题**: 模板中设置的样式（特别是富文本颜色）在 AI 生成内容后会丢失。
        -   **解决方案**: 我们重构了 AI Agent 的核心逻辑，从"信任 AI"转变为**"强制执行规则"**。
            1.  **强制保留 `style` 对象**: 当填充一个模板中已存在的区块时，程序会**完全丢弃** AI 可能返回的任何 `style` 对象，并**强制性地重新应用原始模板中的 `style` 对象**。
            2.  **智能替换富文本**: 程序不再用纯文本粗暴地覆盖 HTML。而是通过在内存中创建一个 DOM 元素，**只替换其 `textContent`**，从而完美保留所有格式标签（如 `<font color="...">`）。

## 5. AI Agent 维护与健壮性：从纪律到架构的飞跃

### 核心挑战："功能-提示词漂移 (Feature-Prompt Drift)"

-   **定义**: 当应用程序的前端组件或核心数据结构 (`types.ts`) 升级后（例如，为 `ImageSection` 添加了 `blur` 属性），依赖这些结构的 AI Agent 的系统指令 (System Prompt) 和 JSON Schema 却没有被**手动**同步更新。这会导致 AI 仍然按照"旧图纸"生成不兼容的"老零件"，引发运行时错误。
-   **结论**: 单纯依赖开发者"记住要去更新"是不可靠的，必须通过架构来解决。

### 最终解决方案："类型即真相"与自动 Schema 生成管线

-   **核心理念**: 我们建立了一个架构级保障，确立了 **`types.ts` 作为定义 AI 数据契约的唯一真相来源 (Single Source of Truth)**。
-   **实现 (`scripts/generate-schemas.ts`)**:
    1.  **自动解析**: 我们创建了一个构建脚本，使用 `ts-morph` 库来程序化地读取和解析 `types.ts` 文件的抽象语法树 (AST)。
    2.  **自动编译**: 该脚本能够将指定的 TypeScript 接口（如 `LayoutBox`, `TextSection`）**自动编译**成我们内部通用的 JSON Schema（轻量格式）。
    3.  **无缝集成**: 这个脚本被集成到了 `dev` 和 `build` 命令中。这意味着，**每一次启动或构建项目时，Schema 都会被自动重新生成**并输出到 `services/generatedSchemas.ts`。
    4.  **架构重构**: 所有的 Agent 服务（如 `posterAgentService.ts`）都被重构，不再包含任何手写的、巨大的 Schema 对象。取而代之的是，它们直接 `import` 并使用这些**永远保持最新**的、自动生成的 Schema。
-   **最终收益**: 这个架构升级从根本上消除了"功能-提示词漂移"的问题。开发者现在可以放心地在 `types.ts` 中修改数据结构，构建系统会自动保证所有 AI Agent 的"知识"同步更新，确保了系统的长期健壮性和可维护性。

## 6. 终极愿景

我们正在构建一个真正的"AI设计师助手"生态系统，而非简单的"内容生成器"。我们的目标是让AI能够：
- 理解用户的设计意图
- 独立操作专业级编辑器
- 生成可完全编辑的结构化设计
- 与人类设计师无缝协作

这一愿景将彻底超越业界主流的"直接图片生成"方案，提供真正适合生产环境的、可持续迭代的设计解决方案。
